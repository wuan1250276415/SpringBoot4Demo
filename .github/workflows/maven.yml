name: Java CI with Maven

# 1. è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶è§¦å‘
on:
  push:
    branches: [ "main" ]

jobs:
  # === ç¬¬ä¸€é˜¶æ®µï¼šæ„å»º (Build) ===
  build:
    runs-on: ubuntu-latest
    # ä½¿ç”¨åŒ…å« Java 25 çš„å®¹å™¨ä½œä¸ºæ„å»ºç¯å¢ƒ
    container:
      image: maven:3.9.12-eclipse-temurin-25-alpine
    steps:
      - uses: actions/checkout@v4

      - name: Build with Maven
        run: mvn clean package

      - name: Upload JAR
        # æŠŠæ„å»ºå¥½çš„ JAR åŒ…å­˜èµ·æ¥ï¼Œä¼ ç»™ä¸‹ä¸€ä¸ªé˜¶æ®µ
        uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: target/*.jar
          retention-days: 1

  # === ç¬¬äºŒé˜¶æ®µï¼šéƒ¨ç½² (Deploy) ===
  deploy:
    needs: build  # å¿…é¡»ç­‰ build æˆåŠŸåæ‰è¿è¡Œ
    runs-on: ubuntu-latest
    permissions:
      packages: write # å…è®¸å†™å…¥ GHCR
      contents: read
    steps:
      - uses: actions/checkout@v4 # éœ€è¦æ‹‰å–ä»£ç ä»“åº“ä¸­çš„ Dockerfile

      - name: Download JAR
        # ä¸‹è½½ä¸Šä¸€é˜¶æ®µä¸Šä¼ çš„ JAR åŒ…
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: target/  # æ”¾å…¥ target ç›®å½•ï¼Œä»¥åŒ¹é… Dockerfile çš„ COPY æŒ‡ä»¤

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Docker Image
        run: |
          # å°†é•œåƒåè½¬æ¢ä¸ºå°å†™ï¼ˆDocker ä¸æ”¯æŒå¤§å†™ï¼‰
          IMAGE_ID=ghcr.io/${{ github.repository_owner }}/my-app
          IMAGE_ID=$(echo $IMAGE_ID | tr '[A-Z]' '[a-z]')
          
          # æ„å»ºå¹¶æ¨é€
          docker build . --file Dockerfile --tag $IMAGE_ID:latest
          docker push $IMAGE_ID:latest

      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # 1. å‡†å¤‡å·¥ä½œï¼šå®šä¹‰å˜é‡
            IMAGE_ID=ghcr.io/${{ github.repository_owner }}/my-app
            IMAGE_ID=$(echo $IMAGE_ID | tr '[A-Z]' '[a-z]')
            
            # 2. æ‹‰å–æœ€æ–°é•œåƒ (å…ˆæ‹‰å–ï¼Œç¡®ä¿é•œåƒæ²¡é—®é¢˜å†åŠ¨å®¹å™¨)
            docker pull $IMAGE_ID:latest
            
            # 3. å¤‡ä»½å½“å‰è¿è¡Œçš„å®¹å™¨ (å¦‚æœæœ‰çš„è¯)
            # å¦‚æœå®¹å™¨æ­£åœ¨è¿è¡Œï¼Œå…ˆåœæ­¢ï¼Œç„¶åé‡å‘½åä¸º backup
            if [ "$(docker ps -q -f name=my-app-container)" ]; then
                docker stop my-app-container
                docker rename my-app-container my-app-backup
            elif [ "$(docker ps -aq -f name=my-app-container)" ]; then
                # å¦‚æœå®¹å™¨å­˜åœ¨ä½†æ²¡è¿è¡Œï¼Œç›´æ¥é‡å‘½å
                docker rename my-app-container my-app-backup
            fi
            
            # 4. å¯åŠ¨æ–°å®¹å™¨
            docker run -d -p 8080:8080 --name my-app-container $IMAGE_ID:latest
            
            # 5. å†’çƒŸæµ‹è¯• & è‡ªåŠ¨å›æ»š ğŸš‘
            echo "Starting health check..."
            
            # å°è¯•è®¿é—®ï¼Œå¦‚æœå¤±è´¥ (||) åˆ™è§¦å‘å›æ»š
            if ! curl --fail --retry 10 --retry-delay 5 --retry-connrefused http://10.0.16.8:8080/actuator/health; then
                echo "âŒ Deployment failed! Starting rollback..."
            
                # --- ä½ çš„å›æ»šé€»è¾‘ ---
                docker stop my-app-container
                docker rm my-app-container
            
                # æ¢å¤å¤‡ä»½ (å¦‚æœå¤‡ä»½å­˜åœ¨)
                if [ "$(docker ps -aq -f name=my-app-backup)" ]; then
                    docker rename my-app-backup my-app-container
                    docker start my-app-container
                    echo "âœ… Rollback successful. Previous version is up."
                else
                    echo "âš ï¸ No backup found. System is down."
                fi
            
                # é‡è¦ï¼šæœ€åå¿…é¡»æŠ¥é”™é€€å‡ºï¼Œè®© GitHub Actions æ˜¾ç¤ºçº¢è‰²âŒï¼Œé€šçŸ¥ä½ æœ‰é—®é¢˜
                exit 1
            fi
            
            # 6. å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œåˆ é™¤ç”±äºå¤‡ä»½äº§ç”Ÿçš„æ—§å®¹å™¨
            echo "âœ… Deployment passed smoke test!"
            docker rm my-app-backup || true
            
      # === 6. é£ä¹¦é€šçŸ¥ (Feishu Notification) ğŸ“¢ ===
      - name: Send Feishu Notification
        if: always()  # ğŸ‘ˆ å…³é”®ï¼šæ— è®ºå‰é¢æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œè¿™æ­¥éƒ½è¦è·‘ï¼
        env:
          # ä» Secrets é‡Œè¯»å– webhook åœ°å€
          WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          # è·å–å½“å‰ä»»åŠ¡çš„è¿è¡Œç»“æœ (success, failure, cancelled)
          JOB_STATUS: ${{ job.status }}
        run: |
          echo "Sending notification to Feishu..."

          # æ ¹æ®çŠ¶æ€å†³å®šå‘é€ä»€ä¹ˆè¡¨æƒ…
          if [ "$JOB_STATUS" == "success" ]; then
            CONTENT="GitHub Actions: éƒ¨ç½²æˆåŠŸï¼âœ… \né¡¹ç›®: ${{ github.repository }}"
          else
            CONTENT="GitHub Actions: éƒ¨ç½²å¤±è´¥ï¼âŒ \nè¯·ç«‹å³æ£€æŸ¥æ—¥å¿—ï¼ğŸš‘ \né¡¹ç›®: ${{ github.repository }}"
          fi

          # å‘é€è¯·æ±‚ (æ³¨æ„ï¼šè¿™é‡Œå¿…é¡»åŒ…å«æˆ‘ä»¬åœ¨é£ä¹¦é‡Œè®¾ç½®çš„å…³é”®è¯ "GitHub")
          curl -X POST -H "Content-Type: application/json" \
            -d "{\"msg_type\":\"text\",\"content\":{\"text\":\"$CONTENT\"}}" \
            $WEBHOOK_URL