name: Java CI with Maven

# 1. è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶è§¦å‘
on:
  push:
    branches: [ "main" ]

jobs:
  # === ç¬¬ä¸€é˜¶æ®µï¼šæ„å»º (Build) ===
  build:
    runs-on: ubuntu-latest
    # ä½¿ç”¨åŒ…å« Java 25 çš„å®¹å™¨ä½œä¸ºæ„å»ºç¯å¢ƒ
    container:
      image: maven:3.9.12-eclipse-temurin-25-alpine
    steps:
      - uses: actions/checkout@v4

      - name: Build with Maven
        run: mvn clean package

      - name: Upload JAR
        # æŠŠæ„å»ºå¥½çš„ JAR åŒ…å­˜èµ·æ¥ï¼Œä¼ ç»™ä¸‹ä¸€ä¸ªé˜¶æ®µ
        uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: target/*.jar
          retention-days: 1

  # === ç¬¬äºŒé˜¶æ®µï¼šéƒ¨ç½² (Deploy) ===
  deploy:
    needs: build  # å¿…é¡»ç­‰ build æˆåŠŸåæ‰è¿è¡Œ
    runs-on: ubuntu-latest
    permissions:
      packages: write # å…è®¸å†™å…¥ GHCR
      contents: read
    steps:
      - uses: actions/checkout@v4 # éœ€è¦æ‹‰å–ä»£ç ä»“åº“ä¸­çš„ Dockerfile

      - name: Download JAR
        # ä¸‹è½½ä¸Šä¸€é˜¶æ®µä¸Šä¼ çš„ JAR åŒ…
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: target/  # æ”¾å…¥ target ç›®å½•ï¼Œä»¥åŒ¹é… Dockerfile çš„ COPY æŒ‡ä»¤

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Docker Image
        run: |
          # å°†é•œåƒåè½¬æ¢ä¸ºå°å†™ï¼ˆDocker ä¸æ”¯æŒå¤§å†™ï¼‰
          IMAGE_ID=ghcr.io/${{ github.repository_owner }}/my-app
          IMAGE_ID=$(echo $IMAGE_ID | tr '[A-Z]' '[a-z]')
          
          # æ„å»ºå¹¶æ¨é€
          docker build . --file Dockerfile --tag $IMAGE_ID:latest
          docker push $IMAGE_ID:latest

      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # 1. ç™»å½• GHCR (å¦‚æœé•œåƒè®¾ä¸º Public å¯çœç•¥æ­¤æ­¥)
            # echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # å®šä¹‰é•œåƒå (ä¿æŒå’Œå°å†™è½¬æ¢é€»è¾‘ä¸€è‡´)
            IMAGE_ID=ghcr.io/${{ github.repository_owner }}/my-app
            IMAGE_ID=$(echo $IMAGE_ID | tr '[A-Z]' '[a-z]')
            
            # 2. åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨ (å¦‚æœå­˜åœ¨)
            docker stop my-app-container || true
            docker rm my-app-container || true
            
            # 3. æ‹‰å–æœ€æ–°é•œåƒ
            docker pull $IMAGE_ID:latest
            
            # 4. å¯åŠ¨æ–°å®¹å™¨
            docker run -d -p 8080:8080 --name my-app-container $IMAGE_ID:latest
            
            # === 5. å†’çƒŸæµ‹è¯• (Smoke Test) ğŸš‘ ===
            echo "Starting application health check..."
            # å°è¯•è®¿é—®å†…ç½‘åœ°å€ï¼Œæœ€å¤šé‡è¯• 10 æ¬¡ï¼Œæ¯æ¬¡é—´éš” 5 ç§’
            curl --fail --retry 10 --retry-delay 5 --retry-connrefused http://10.0.16.8:8080/actuator/health